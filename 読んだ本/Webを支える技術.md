Webを支える技術を読んで知ったこと

## Rest
* RESTはWebのアーキテクチャスタイル
（アーキテクチャスタイルは作法とか流儀を指す
MVCモデルとか）
* Restは６つのアーキテクチャによって構成される
```
1. クライアント/サーバー方式
    ユーザーとインターフェースと処理を分離する
2. ステートレスサーバ
    サーバー側でアプリケーション状態を持たない
3. キャッシュ
    クライアントとサーバの通信回数と量を減らす
4. 統一インターフェース
    インターフェースを固定する
5. 階層化システム
    システムを階層に分離する
6. コードオンデマンド
    プログラムをクライアントにダウンロードして実行する
```
設計するときはRestの考えたに沿って設計するとあまりブレない
ただし、絶対にその通りにする必要もないので状況に応じて対応する

## HTTP
* HTTPとはRFC2616で規定されたプロトコル
[RFCとは](https://www.nic.ad.jp/ja/newsletter/No24/090.html)

* HTTPではクライアントが出したリクエストをサーバーで処理してレスポンスを返す
このようなプロトコルはリクエスト/レスポンス型プロトコルと呼ぶ。

#### HTTPメッセージ
メッセージはステートレスで送られる
ステートレスとはサーバーに情報を保管せずに、リクエストに全ての情報を乗っける仕組み
##### リクエストメッセージ
リクエストライン、ヘッダ、ボディにて構成される
```
GET /test HTTP/1.1
HOST: example.jp 
```
* リクエストメッセージの一行目はリクエストラインと呼ばれ、メソッド(GET)、リクエストURI(/test)、プロトコルバージョン(HTTP/1.1)で構成される

* ２行目以降はヘッダが続く。メッセージのメタデータ。
    例ではHOSTにexample.jpが結び付けられている。
* ヘッダのあとにボディが続くこともある。ボディにはそのメッセージを表す本質的な情報が入る。
##### レスポンスメッセージ
ステータスライン、ヘッダ、ボディにて構成される
``` 
HTTP/1.1 200 OK
Content-Type: application/xhtml+xml; charaset=utf-8

<html xmls="http://~">
...
</html>
```
* レスポンスメッセージの一行目はステータスラインと呼び、
プロトコルバージョン（HTTP/1.1）ステータスコード(200)、テキストフレーズ(OK)からなる。

* レスポンスメッセージの2行目以降は、ヘッダとなる。メタデータが入る。

* ボディ、例だと`<html>`のところからになる。

#### HTTPメソッド
全８種類
``` 
GET:リソースの取得
POST:子リソースの作成、リソースへのデータ追加、その他の処理
PUT:リソースの更新、リソースの作成
DELETE:リソースの削除
HEAD:リソースのヘッダの取得
OPTION:リソースがサポートしているメソッドの取得
TRACE:自分宛にリクエストメッセージを返す（試験用）
CONNECT:プロキシ動作のトンネル接続への変更
```
TRACEとCONNECTはほとんど使用されていない
##### HTTPメソッドのべき等性と安全性
べき等性とは「ある操作を何回おなこなっても結果が同じこと」
```
GET、HEAD→べき等かつ安全
PUT、DELETE→べき等だが安全でない
POST→べき等でも安全でもない
```
※POSTは万能メソッドで割となんでもできるが、べき等かつ安全ではないので他のメソッドが使える場合はそちらを優先すること

##### ステータスコードの分類
レスポンスメッセージの１行目に含まれるステータスコードの分類
404エラーとかの話
```
1.xx:処理中
2.xx:成功
3.xx:リダイレクト
4.xx:クライアントエラー
5.xx:サーバエラー
```
頭の数字で状態がわかるようになっている。
また、設計する場合はステータスコードを意識して設計する必要がある。
特に重要なのは4.xx1系のエラーコードで、多様なステータスコードがあるのできちんと選択すること

##### HTTPヘッダ

* Dateを持つヘッダ
httpでは日時は全てGMTで表す。これによりサマータイムの問題を回避できたりする。
    ``` 
    Date:Tue,06 jul 2010 03:21:05 GMT
    ```
* MIMEメディアタイプ
リソースの表現の種類を指定する
    * Contents-Type
        ```
        content-Type: application/xhtml+xml; charaset=utf-8
        ```
        application/xhtml+xmlがメディアタイプ
        /の左側をタイプ、右側をサブタイプと呼ぶ
        タイプは勝手に増やすことはできない。9つ予め定義されている。
    * charasetパラメータ
        メディアタイプはcharasetパラメータを持てる
        charset=utf8とすればutf-8でエンコードしていることを示す。
        **charsetパラメータのバッドノウハウ**
        charasetパラメータを省略した場合のデフォルトエンコーディングはutf-8ではなくISO8859-1となっており、日本語だと文字化けする。
        さらに、xmlなど単体で文字コードエンコーディングが宣言できる場合でもtextタイプではcharsetパラメータを優先しなければいけない。
        この問題を回避するためには、charsetはパラメータを省略せずにu指定するのが現状最も良い。
* 言語タグ
        Contents-Languageヘッダの値は「言語タグ」と呼ばれる文字列
        ```
        ContentーLanguage: ja-JP
        ```
* コンテントネゴシエーション
    上のメディアタイプや文字エンコーディング、言語タグはサーバが一方的に決定するだけではなく、クライアントと交渉(ネゴシエーション)して決めること**も**できます。
    `q=`はqvalueと呼び、そのメディアタイプの優先度を示す。
    0~1までの値で指定する
    * Accept -処理できるメディアタイプを伝える
        ```
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
        ```
        上の例だとxmlが優先度高い
        クライアントがAcceptヘッダで指定したメディアタイプにサーバが対応していなかった場合は、`406 Not Acceptable`が返ってくる
    * Accept-Charset -処理出来る文字エンコーディング
        ``` 
        Accept-Charset:Shift_JIS,utf-8,q=0.7,*;q=0.7
        ```
        上の例だとShift-Jisが優先度１となり、その次にデフォルト値のISO8869-1が優先となり、そのほかは0.7の優先度となります。
    * Accept-Language-処理出来る言語を伝える
        ```
        Accept-Language: ja,en-us;q=0.7,en;q=0.3 
        ```
        上の例だと、jaが1、en-usが0.7、enが0.3の優先度
* Content-Lengthとチャンク転送
    メッセージがボディを持っている場合基本的には`Content-Length`を使用して10進数のバイトで示す。
    ```
    Content-Length: 5538
    ```
* チャンク転送
    ```
    Transfer-Encoding: chunkd
    ```
    ボディを分割して送付できる

* 認証
Basic認証とDigest認証がある
Basic認証はIDとパスワードを:で連結し、Base64エンコードする方式。
Base64はすぐに複合できるのでそれがOKなのか、ダメならTLSなどを使ってHTTPS通信し通信経路上で暗号化をするのかを検討する必要がある
Digest認証はパスワードが盗まれる心配のない方式だが、複雑なのであまり使われていない。

##### キャッシュとは
サーバーから取得したリソースをローカルストレージに保存し再利用する仕組み。
* キャッシュ用ヘッダ
    * Pragma --キャッシュ用レスポンスヘッダ
        ```
        pragma: no-cache
        ```
        pragmaに指定できるのは`no-cache`のみ
        キャッシュさせないことを示す
    * Expire --キャッシュの有効期限を示す
        ```
        Expire: Thu, 11 May 2010 16:00:00 GMT
        ```
        キャッシュの有効期限を示す
    * Cache-Control --詳細なキャッシュ方法を指定する
    html1.1から追加された機能
    上記二つはCache-Controlにて代用できる。
    ```
    Pragma: no-cache
    は
    Cache-Control: no-cache 
    ```
    ```
    Cache-Control:max-age:86400
    は24時間キャッシュが有効であることを示す
    ```

